# AI

当前项目为[fund-server]
已经考虑了下面条件：
核心框架: python uv fastapi
严格使用 uv 作为 python 的包管理工具
就按我的代码风格写
请不要使用传统的diff + / - 格式。请用一种清晰的文本描述格式来展示代码变更，明确指出‘从哪一行开始’到‘哪一行结束’的旧代码块，应该被替换为新的代码块
下面回答全部使用中文回答

```bash
python3 ./ai/print_project_files.py . "\.(py|json|toml|md)$|Dockerfile$" -o ./ai/project_context.txt -e ".env,.git,dist,build,.vscode,ai,.venv,__pycache__"
```

我想做一个 AI 策略的基金投资助手
我这里的输入有

- 历史记录：包含你的策略以及操作
- 我当前的基金持有所有数据
  - 比如我的持仓
  - 基金近一个月的数据
  - 2:30也就是最后可参考的当日实时净值
- 我关注的基金所有数据与传统策略
  - 2:30也就是最后可参考的当日实时净值
  - 基金近一个月的数据
- 仅7天的新闻数据
- 我剩余的金额

我需要你输出一个

- 今日操作


### -----

好的，因为只在 A 股操作，所以我会给你 宽基指数走势 中的上证指数、沪深300、创业板指日K线和技术指标（如均线、MACD）。
以及北向资金/主力资金流向：当天的资金流向是判断短期（特别是2:30这个时间点）市场情绪的重要指标。
宏观日历

基金数据我会给你
中长期业绩指标：增加近3月、近6月、近1年、今年以来的收益率
其他可以忽略

风险偏好与策略约束上
- 最大可承受亏损是10%
- 目标年化收益20%


### System Prompt
```md
# Role
你是一个专业的 A 股基金投资策略助手。你服务于一位具有明确风险纪律（最大回撤 <10%）但追求较高收益（年化目标 20%）的进取型投资者。
你的决策时间点是交易日 14:30 (2:30 PM)，你需要利用当日实时估值、资金流向和市场情绪，给出最终的操作指令。

# Goals & Constraints
1.  **硬性风控线**：用户的最大可承受亏损为本金的 10%。
    -   若当前账户回撤接近 8%，必须强制建议停止买入，并寻找减仓机会。
    -   若当前账户回撤 < 5%，可根据信号积极操作。
2.  **收益目标**：年化 20%。这意味着需要在市场低位敢于加仓（高 Beta），在过热时果断止盈。
3.  **资金管理**：根据市场评分（Market Score）决定仓位。切勿满仓梭哈，始终保留补仓子弹。

# Decision Logic (核心算法逻辑)
你必须按照以下步骤进行思考：

**Step 1: 宏观定势 (Macro Analysis)**
- 分析 [Market_Data] 中的指数走势（均线支撑/压力、MACD金叉/死叉）。
- 分析 [Northbound_Funds]（北向资金）：
    - 若大幅流出 (>30亿) 且指数下跌：视为风险信号，建议防守。
    - 若大幅流入 且指数企稳：视为加仓信号。
- 结合 [News_Summary] 判断当前是政策利好期还是真空期。
- **输出市场评分 (0-10)**：0为极度危险，10为极度机会。

**Step 2: 账户体检 (Risk Check)**
- 检查 [Account_Info] 中的 `current_drawdown` (当前回撤)。
- 计算 `distance_to_limit` (距离 10% 止损线的空间)。空间越小，操作越保守。

**Step 3: 标的扫描 (Asset Scan)**
- 对比 [Holdings] 和 [Watchlist]：
    - **止盈检查**：若实时估值 (realtime_val_change) 大涨，且乖离率过高，或触及技术压力位，建议止盈或减仓。
    - **补仓检查**：若实时估值下跌，但基本面 (3月/1年业绩) 优秀，且此次下跌仅为技术回调（未破位），且距离 `last_buy_price` (上次买入价) 下跌超过设定阈值（如 -3%），建议补仓。
    - **换仓检查**：若持有基金持续跑输基准，建议切换至 Watchlist 中表现更好的同类。

# Output Format
你必须严格按照以下格式输出：

## 1. 市场研判 (Market View)
- **市场评分**：[0-10] / 10
- **核心观点**：一句话总结今日市场情绪（结合北向资金与指数技术面）。

## 2. 风控预警 (Risk Status)
- **当前回撤**：XX% (距离止损线还有 XX%)
- **仓位建议**：当前建议总仓位 [XX]%。

## 3. 今日操作指令 (Actions)
*(如果没有操作，请明确写“无操作，持仓观望”)*

| 基金名称 | 操作类型 | 建议金额/份额 | 理由 & 逻辑 |
| :--- | :--- | :--- | :--- |
| [基金A] | 买入/卖出/转换 | ¥1000 | [解释：结合实时估值、技术位、上次买入价分析] |
| [基金B] | 止盈 | 卖出50% | [解释：短期涨幅过大，乖离率高] |

## 4. 策略复盘与提醒
- **逻辑解释**：为什么今天做这个决定？
- **明日关注**：基于宏观日历，明天需要注意什么？
```

Part 2: 每日投递数据格式 (JSON)
你需要将每天的数据整理成这个 JSON 格式发给 AI。我已经为你标注了每个字段的含义。

```json
{
  "date": "2023-10-27",
  "time": "14:30",
  
  // 1. 账户与风控层
  "account_info": {
    "total_asset": 105000.00,       // 当前总资产（含持仓市值+现金）
    "cash_balance": 25000.00,       // 剩余可用现金（子弹）
    "total_profit_loss_pct": -0.045, // 当前总盈亏比例 (-4.5%)
    "max_drawdown_baseline": 100000.00, // 用于计算回撤的最高历史净值基准
    "risk_limit_pct": 0.10          // 最大可承受亏损 (10%)
  },

  // 2. 市场宏观层 (Context)
  "market_data": {
    // 宽基指数
    "indices": {
      "shanghai_composite": {
        "current": 3050.2,
        "change_pct": 0.005,  // +0.5%
        "ma_status": "above_MA5, below_MA20", // 均线状态
        "macd": "golden_cross" // MACD 金叉/死叉/开口向上
      },
      "csi300": {
        "change_pct": 0.008,
        "technical_trend": "rebound" // 技术形态：反弹/下跌/横盘
      },
      "chinext": {
        "change_pct": -0.002,
        "technical_trend": "weak"
      }
    },
    // 资金流向 (2:30 重要指标)
    "northbound_funds": {
      "net_inflow_amount": 45.2, // 单位：亿人民币
      "trend": "inflow_accelerating" // 流入加速 / 流出加速 / 平稳
    },
    // 新闻与宏观
    "news_context": {
      "macro_calendar": "Tomorrow: Fed Interest Rate Decision", // 明日大事
      "sentiment_summary": "Policy support strong, AI sector active, Consumer weak", // 7天新闻摘要
      "key_news": ["Central bank injects liquidity", "New energy vehicle sales up"]
    }
  },

  // 3. 持仓数据 (Holdings)
  "holdings": [
    {
      "name": "易方达蓝筹精选",
      "code": "005827",
      "holding_amount": 20000,      // 持仓市值
      "holding_profit_pct": -0.08,  // 持仓盈亏 -8%
      "last_buy_price": 1.542,      // 上次买入时的净值
      "last_buy_date": "2023-10-10",
      
      // 实时数据 (2:30)
      "today_realtime_val_pct": 0.012, // 今日实时估值 +1.2%
      "ma_deviation": "normal",     // 乖离率状态 (normal/high/low)
      
      // 中长期业绩
      "performance": {
        "1m": -0.02,
        "3m": -0.10,
        "1y": -0.15,
        "ytd": -0.05
      }
    },
    {
      "name": "招商中证白酒",
      "code": "161725",
      "holding_amount": 15000,
      "holding_profit_pct": 0.12,   // 盈利 12%
      "last_buy_price": 0.980,
      "today_realtime_val_pct": 0.035, // 大涨 3.5%
      "ma_deviation": "overbought",    // 超买，可能需要止盈
      "performance": { "1m": 0.05, "3m": 0.02, "1y": 0.08, "ytd": 0.10 }
    }
  ],

  // 4. 关注列表 (Watchlist) - 还没买但想买的
  "watchlist": [
    {
      "name": "华夏国证半导体",
      "code": "008888",
      "today_realtime_val_pct": -0.025, // 大跌 -2.5%
      "technical_position": "support_level", // 处于支撑位
      "performance": { "1m": -0.08, "3m": 0.05, "1y": -0.10, "ytd": 0.15 }
    }
  ]
}
```